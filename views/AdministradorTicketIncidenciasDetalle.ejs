<% if (req.session.me) { %>

   <div id="wrapper">

      <nav class="navbar-default navbar-static-side" role="navigation">
         <div class="sidebar-collapse">
            <ul class="nav metismenu" id="side-menu">
               <li class="nav-header">
                  <div class="dropdown profile-element">
                     <span>
                     <img alt="image" class="img-circle" src="logo.png" width="30%" height="10%" />
                  </span>
                     <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                        <span class="clear">
                        <span class="block m-t-xs">
                           <strong class="font-bold">Usuario</strong>
                        </span>
                        <span class="text-muted text-xs block">
                           <%= req.session.me.nombre %>
                           <b class="caret"></b>
                        </span>
                        </span>
                     </a>
                     <ul class="dropdown-menu animated fadeInRight m-t-xs">
                        <li>
                           <a href="/GloblalPerfil?user=<%= req.session.me.idUsuario %>">Perfil</a>
                        </li>
                        <li>
                           <a href="usuario/logout">Cerrar Sesión </a>
                        </li>
                     </ul>
                  </div>
                  <div class="logo-element">
                     TI+
                  </div>
               </li>
               <li>
                  <a href="/AdministradorInicio" class="active">
                     <i class="fa fa-area-chart"></i>
                     <span class="nav-label">Inicio</span>
                  </a>
               </li>
               <li>
                  <a href="">
                     <i class="fa fa-id-badge"></i>
                     <span class="nav-label">Clientes</span>
                     <span class="fa arrow"></span>
                  </a>
                  <ul class="nav nav-second-level collapse">
                     <li>
                        <a href="/AdministradorClienteEmpresa">
                           <i class="fa fa-bank"></i>Empresas</a>
                     </li>
                     <li>
                        <a href="/AdministradorClienteTrabajador">
                           <i class="fa fa-id-card-o"></i>Contactos</a>
                     </li>
                  </ul>
               </li>
               <li>
                  <a href="/AdministradorProducto">
                     <i class="fa fa-shopping-cart"></i>
                     <span class="nav-label">Productos</span>
                  </a>
               </li>
               <li class="active">
                  <a href="">
                     <i class="fa fa-ticket"></i>
                     <span class="nav-label">Tickets</span>
                     <span class="fa arrow"></span>
                  </a>
                  <ul class="nav nav-second-level collapse">
                     <li>
                        <a href="/AdministradorTicketRegistrar">
                           <i class="fa fa-save"></i>Nuevo Ticket</a>
                     </li>
                     <li class="active">
                        <a href="/AdministradorTicketIncidencias">
                           <i class="fa fa-th-list"></i>Incidencias</a>
                     </li>
                     <li>
                        <a href="/AdministradorTicketBusquedas">
                           <i class="fa fa-search"></i>Consultas</a>
                     </li>
                  </ul>
               </li>
               <li>
                  <a href="/AdministradorReporteTicket">
                     <i class="fa fa-file"></i>
                     <span class="nav-label">Informe Ticket</span>
                  </a>
               </li>
            </ul>

         </div>
      </nav>

      <div id="page-wrapper" class="gray-bg">
         <div class="row border-bottom">
            <nav class="navbar navbar-static-top  " role="navigation" style="margin-bottom: 0">
               <div class="navbar-header">
                  <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#">
                     <i class="fa fa-bars"></i>
                  </a>
               </div>
               <ul class="nav navbar-top-links navbar-right">
                  <li>
                     <span class="m-r-sm text-muted welcome-message">Bienvenido
                     <%= req.session.me.nombre %>
                  </span>
                  </li>

                  <li>
                     <a href="usuario/logout">
                        <i class="fa fa-sign-out"></i> Cerrar Sesión
                     </a>
                  </li>
               </ul>

            </nav>
         </div>
         <div class="row wrapper border-bottom white-bg page-heading">
            <div class="col-sm-4">
               <h2>Ticket</h2>
               <ol class="breadcrumb">
                  <li>
                     <a href="">Ticket</a>
                  </li>
                  <li class="active">
                     <strong>Registro Incidencias</strong>
                  </li>
               </ol>
            </div>
         </div>

         <div class="wrapper wrapper-content animated fadeInRight">

            <div class="row">
               <div class="col-md-12">
                  <div class="ibox collapsed">
                     <div class="ibox-title" style="background: white">
                        <div id="detalleTicket">
                           <h5>Ticket Pendiente de Incidencias</h5>
                        </div>
                        <div class="ibox-tools">
                           <a class="" id="aperturaTicket" style="color: black">
                              <i class="fa fa-clock-o"></i>
                           </a>
                           <a class="" id="estadoTicket" style="color: black">
                              <i class="fa fa-cogs"></i>
                           </a>
                           <a class="collapse-link">
                              <i class="fa fa-chevron-up"></i>
                           </a>
                        </div>
                     </div>
                     <div class="ibox-content">
                        <div class="row">
                           <div class="col-md-6 col-sm-12">
                              <h5>Staffs Atendiendo el Ticket</h5>
                              <ol class="dd-list" id="usuariosAsignadosTicket">
                              </ol>
                           </div>
                           <div class="col-md-6 col-sm-12">
                              <h5>Clientes Pertenecientes al Ticket</h5>
                              <ol class="dd-list" id="clientesAsignadosTicket">
                              </ol>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>

            <div class="alert alert-warning" id="panelAviso1" style="display: none">
               <b>Para realizar el registro de una incidencia debe finalizar el seguimiento de la útima incidencia
               registrada.</b>
            </div>

            <div class="alert alert-danger" id="panelAviso2" style="display: none">
               <b>El ticket seleccionado se encuentra finalizado, no podrá realizar más registros de incidencias.</b>
            </div>

            <div class="row" id="panelAviso3" style="display: block">
               <div class="col-md-12">
                  <div class="ibox collapsed">
                     <div class="ibox-title">
                        <h5> Registrar Incidencia &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                           <small>Expandir para registrar incidencia</small>
                        </h5>
                        <div class="ibox-tools">
                           <a class="collapse-link">
                              <button class="btn btn-success">
                              <i class="fa fa-chevron-up"></i> Agregar Incidencia</button>
                           </a>
                           <a class="">
                              <button type="submit" id="btnFinalizarTicket" class="btn btn-danger">
                              <i class="fa fa-times"></i> Finalizar Ticket </button>
                           </a>
                        </div>
                     </div>

                     <div class="ibox-content">
                        <div class="tabs-container">
                           <ul class="nav nav-tabs">
                              <li id="tabIncidencia" class="active" style="display: block">
                                 <a data-toggle="tab" href="#tab-1"> Registrar Incidencia</a>

                              </li>
                              <li id="tabAdjuntos" style="display: none">
                                 <a data-toggle="tab" href="#tab-2"> Adjuntar Archivos</a>
                              </li>
                           </ul>
                           <div class="tab-content">
                              <div id="tab-1" class="tab-pane active">
                                 <div class="panel-body">

                                    <div class="row" style="display: none">
                                       <div class="col-md-12">
                                          <div class="form-group">
                                             <label>Ticket Asignado</label>
                                             <input type="text" placeholder="Ticket Asignado" class="form-control" id="idTicketIncidencia" style="display: none">
                                             <label class="form-control" id="idTicketIncidenciaVisible">00000000</label>

                                          </div>
                                       </div>
                                    </div>

                                    <div class="row">
                                       <div class="col-md-9">
                                          <div class="form-group">
                                             <label>Encargado Incidencia</label>
                                             <input type="text" id="nombreEncargado" placeholder="Ticket Asignado" class="form-control" style="display: none" value="<%= req.session.me.nombre %>">
                                             <label class="form-control">
                                             <%= req.session.me.nombre %>
                                          </label>
                                          </div>
                                       </div>
                                       <div class="col-md-3">
                                          <div class="form-group">
                                             <label> &nbsp;</label>
                                             <br>
                                             <button type="button" style="width: 100%" class="btn btn-primary" data-toggle="modal" data-target="#myModal6" id="btnCargarClientes">
                                             <i class="fa fa-plus"></i> Agregar Cliente al Ticket
                                          </button>
                                          </div>
                                       </div>
                                    </div>

                                    <div class="row">
                                       <div class="col-md-12">
                                          <div class="form-group">
                                             <label>Lugar Incidencia</label>
                                             <select id="cbxLugarTrabajo" class="form-control">
                                             <option value="REMOTO">REMOTO</option>
                                             <option value="EN SITIO">EN SITIO</option>
                                          </select>
                                          </div>
                                       </div>
                                    </div>

                                    <div id="tiempoIncidenciaSitio" style="display: none">
                                       <hr>
                                       <div class="row">
                                          <div class="col-md-6">
                                             <div class="form-group">
                                                <label>Fecha Inicio Incidencia</label>
                                                <div class="fechas form-group">
                                                   <div class="input-group date">
                                                      <span class="input-group-addon">
                                                      <i class="fa fa-calendar"></i>
                                                   </span>
                                                      <input type="text" class="form-control" id="fechaInicio">
                                                   </div>
                                                </div>
                                             </div>
                                          </div>
                                          <div class="col-md-6">
                                             <div class="form-group">
                                                <label>Hora Inicio Incidencia</label>
                                                <div class="input-group clockpicker" data-autoclose="true">
                                                   <span class="input-group-addon">
                                                   <span class="fa fa-clock-o"></span>
                                                   </span>
                                                   <input type="text" class="form-control" value="00:00" id="tiempoIncio">
                                                </div>
                                             </div>
                                          </div>
                                       </div>

                                       <div class="row">
                                          <div class="col-md-6">
                                             <div class="form-group">
                                                <label>Fecha Fin Incidencia</label>
                                                <div class="fechas form-group">
                                                   <div class="input-group date">
                                                      <span class="input-group-addon">
                                                      <i class="fa fa-calendar"></i>
                                                   </span>
                                                      <input type="text" class="form-control" id="fechaFin">
                                                   </div>
                                                </div>
                                             </div>
                                          </div>
                                          <div class="col-md-6">
                                             <div class="form-group">
                                                <label>Hora Fin Incidencia</label>
                                                <div class="input-group clockpicker" data-autoclose="true">
                                                   <span class="input-group-addon">
                                                   <span class="fa fa-clock-o"></span>
                                                   </span>
                                                   <input type="text" class="form-control" value="00:00" id="tiempoFin">
                                                </div>
                                             </div>
                                          </div>
                                       </div>
                                       <hr>
                                    </div>

                                    <div class="row">
                                       <div class="col-md-12">
                                          <div class="form-group">

                                             <label>Descripción Incidencia</label>
                                             <textarea id="summernote" name="editordata" id="descripcion"></textarea>
                                          </div>
                                       </div>
                                    </div>

                                    <div class="row">
                                       <div class="col-md-12">
                                          <a data-toggle="tab" href="#tab-2" id="btnGuardarIncidencia" class="btn btn-primary" style="width: 100%">
                                             <i class="fa fa-arrow-circle-o-right"></i> Guardar Incidencia</button>
                                          </a>
                                       </div>
                                    </div>

                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>

            <div class="row">
               <div class="col-md-12">
                  <div class="ibox float-e-margins">
                     <div class="ibox-title">
                        <h5>Ticket Incidencias | </h5>
                        <span class="label label-success" id="numeroTicket"> 0 </span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                        <span id="ultimoRegistro">

                     </span>
                        <div class="ibox-tools">
                           <a class="collapse-link">
                              <i class="fa fa-chevron-up"></i>
                           </a>
                           <a class="close-link">
                              <i class="fa fa-times"></i>
                           </a>
                        </div>
                     </div>
                     <div class="ibox-content">

                        <div id="incidenciasDetalles">

                        </div>

                     </div>
                  </div>
               </div>
            </div>
         </div>

         <div class="footer">
            <div>
               <strong>Innovacloud </strong> Ticketing &copy; 2020 - 2021
            </div>
         </div>

         <div class="modal inmodal fade" id="mdArchivos" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-md">
               <div class="modal-content">
                  <div class="modal-header">
                     <button type="button" class="close" data-dismiss="modal">
                     <span aria-hidden="true">&times;</span>
                     <span class="sr-only">Close</span>
                  </button>
                     <h4 class="modal-title">Asignar Archivos a la Incidencia</h4>
                  </div>
                  <div class="modal-body">
                     <form id="fmrGuardarArchivo" enctype="multipart/form-data" action="/archivo/guardarArchivo" method="post">
                        <div class="row">
                           <div class="col-md-12">
                              <div class="form-group">
                                 <label>Incidencia Asignada</label>
                                 <input type="text" placeholder="Incidencia Asignada" class="form-control" name="idIncidencia" id="idIncidencia" style="display: none">
                                 <label class="form-control" id="idIncidenciaVisible">00000000</label>

                              </div>
                           </div>
                        </div>
                        <input type="text" name="idModulo" id="idModulo" style="display: none">
                        <div class="row">
                           <div class="col-md-12 ">
                              <div class="form-group">
                                 <div class="">
                                    <label>Adjuntar Archivos</label>
                                    <input id="archivo" name="archivo" type="file" class="file" data-show-preview="false" data-show-upload="false" multiple>

                                 </div>
                              </div>
                           </div>
                        </div>
                        <br>
                  </div>
                  <div class="modal-footer">

                     <button type="submit" class="btn btn-primary" id="btnAdjuntar" style="width: 100%">
                     <i class="fa fa-save"></i> Guardar Archivos</button>
                     <br>
                     <br>
                     <button type="button" class="btn btn-white" data-dismiss="modal" style="width: 100%">Cancelar</button>
                  </div>
                  </form>
               </div>
            </div>
         </div>

         <div class="modal inmodal fade" id="myModal6" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-md">
               <div class="modal-content">
                  <div class="modal-header">
                     <button type="button" class="close" data-dismiss="modal">
                     <span aria-hidden="true">&times;</span>
                     <span class="sr-only">Close</span>
                  </button>
                     <h4 class="modal-title">Agregar Cliente al Ticket</h4>
                  </div>
                  <div class="modal-body">
                     <h3 style="font-weight: bold">Asignar un Nuevo Cliente al Ticket</h3>
                     <div class="row">
                        <div class="col-md-12">
                           <div class="form-group">
                              <label>Clientes</label>
                              <select id="idClienteNuevo" class="form-control">

                           </select>
                           </div>
                        </div>
                     </div>
                  </div>
                  <div class="modal-footer">
                     <button type="button" class="btn btn-white" data-dismiss="modal">Cancelar</button>
                     <button type="button" class="btn btn-primary" id="btnAsignarCliente">Asignar Cliente</button>
                  </div>
               </div>
            </div>
         </div>


         <script>
            var ticket = $.get("ticket");
            var idUsuarioSesion = $.get("idUsuarioSesion");

            $('#idTicketIncidencia').val(ticket);
            $('#idTicketIncidenciaVisible').html(ticket);

            $('#idModulo').val('AdministradorTicketIncidenciasDetalle?ticket=' + ticket + '&idUsuarioSesion=' + idUsuarioSesion + '');

            $('#summernote').summernote({
               toolbar: [
                  ['style'],
                  ['fontStyle', ['fontname', 'fontsize']],
                  ['color', ['color']],
                  ['para', ['ul', 'ol', 'paragraph']],
                  ['insert', ['picture', 'table']],
               ],
               fontNames: ['Arial Narrow'],
               height: 300
            });

            $('.clockpicker').clockpicker();

            $('.fechas .input-group.date').datepicker({
               todayBtn: "linked",
               keyboardNavigation: false,
               forceParse: false,
               calendarWeeks: true,
               autoclose: true,
               format: "yyyy-mm-dd"
            }).datepicker('setDate', new Date());

            buscarIncidencias();



            $('#cbxLugarTrabajo').multiselect('destroy');
            $('#cbxLugarTrabajo').multiselect({
               includeSelectAllOption: true,
               enableFiltering: true,
               buttonWidth: '100%',
               maxHeight: 200,
               onChange: function(element, checked) {
                  var lugarTrabajo = $('#cbxLugarTrabajo').val();
                  if (lugarTrabajo == 'EN SITIO') {
                     $("#tiempoIncidenciaSitio").css("display", "block");
                  } else if (lugarTrabajo == 'REMOTO') {
                     $("#tiempoIncidenciaSitio").css("display", "none");
                  }
               }
            });

            function reloadPage() {
               location.reload();
            }

            function obtenerArchivos(json) {

               var retorno = '' + json;

               console.log("llegó", json);

               var archivo = JSON.parse(json);
               var htmlOut = '';
               for (var i = 0; i < archivo.length; i++) {
                  htmlOut += '<a href="' + archivo[i].ubicacion + '" target="_blank" class="btn btn-default" style="font-size: 14px" ><i class="fa fa-file-archive-o"></i> ' + archivo[i].nombre + '</a>&nbsp;&nbsp;&nbsp;';

               }

               retorno = htmlOut;

               return retorno;
            }

            $("#btnGuardarIncidencia").click(function() {

               var idTicket = $('#idTicketIncidencia').val();
               var cliente_usuario = $('#nombreEncargado').val();

               var lugarTrabajo = $('#cbxLugarTrabajo').val();
               var descripcion = $('#summernote').val();

               if (validarCampos(3)) {
                  io.socket.post('/incidencia', {
                     lugarTrabajo: lugarTrabajo,
                     descripcion: descripcion,
                     id_cliente_usuario: idUsuarioSesion,
                     cliente_usuario: cliente_usuario,
                     idTicket: idTicket
                  }, function(resData, jwRes) {
                     if (jwRes.statusCode == 201) {

                        toastr.success('Incidencia Guardada Exitosamente', 'Gestión Incidencia');

                        guardarTiempoIncidencia(resData.idIncidencia, lugarTrabajo);
                        EnvioEmailIncidencia(resData.idIncidencia);
                        buscarIncidencias();
                        $('#summernote').summernote('code', '');

                     } else {
                        toastr.error('Error al Guardar Incidencia', 'Gestión Incidencia');
                     }
                  });
               }

            });

            $("#btnFinalizarTicket").click(function() {
               var idTicket = $('#idTicketIncidencia').val();
               var fecha = new Date();
               var fechaCierre = fecha.getFullYear() + "-" + (fecha.getMonth() + 1) + "-" + fecha.getDate() + " " + fecha.getHours() + ":" + fecha.getMinutes() + ":" + fecha.getSeconds();
               finalizarTicket(idTicket, fechaCierre);
            });

            function finalizarTicket(idTicket, fechaCierre_) {

               io.socket.post('/ticket/endTicket', {
                  fechaCierre: fechaCierre_,
                  estado: 'FINALIZADO POR FACTURAR',
                  ticket: idTicket
               }, function(resData, jwRes) {
                  if (jwRes.statusCode == 201) {

                     toastr.success('Ticket Finalizado Correctamente', 'Gestión Ticket');
                     actualizarTiempoTotalTicket(idTicket);

                  } else {
                     toastr.error('Error al Finalizar Ticket', 'Gestión Ticket');
                  }
               });
            }

            function actualizarTiempoTotalTicket(idTicket_) {

               io.socket.post('/ticket/updateTime', {
                  idTicket: idTicket_
               }, function(resData, jwRes) {
                  if (jwRes.statusCode == 201) {

                     toastr.success('Tiempo Total del Ticket Asignado Correctamente', 'Gestión Ticket');

                     envioEmailFinTicket();
                     buscarIncidencias();

                  } else {
                     toastr.error('Error al Asignar Tiempo Total al Ticket', 'Gestión Ticket');
                  }
               });
            }

            //GUARDAR TIEMPO INCIDENCIA
            function guardarTiempoIncidencia(idIncidencia_, lugar) {

               if (lugar == 'EN SITIO') {

                  var fechaInicio = $("#fechaInicio").val();
                  var fechaFin = $("#fechaFin").val();
                  var tiempoInicio = $("#tiempoIncio").val();
                  var tiempoFin = $("#tiempoFin").val();

                  var tiempoTranscurridoSegundos = convertirASegundos(fechaInicio, tiempoInicio, fechaFin, tiempoFin);

                  io.socket.post('/tiempo_incidencia/saveIncidencia', {
                     fechaInicio: (fechaInicio + ' ' + tiempoInicio),
                     fechaFinal: (fechaFin + ' ' + tiempoFin),
                     idIncidencia: idIncidencia_,
                     tiempo: tiempoTranscurridoSegundos
                  }, function(resData, jwRes) {
                     console.log(JSON.stringify(resData));
                     if (jwRes.statusCode != 201) {
                        toastr.error('Error al guardar tiempo de la incidencia en Sitio', 'Gestión Incidencia');
                     }
                  });
               }
               if (lugar == 'REMOTO') {

                  var fecha = new Date();

                  var fecha = fecha.getFullYear() + "-" + (fecha.getMonth() + 1) + "-" + fecha.getDate() + " " + fecha.getHours() + ":" + fecha.getMinutes() + ":" + fecha.getSeconds();

                  io.socket.post('/tiempo_incidencia', {
                     fechaInicio: fecha,
                     idIncidencia: idIncidencia_,
                     estado: 'EN EJECUCIÓN'
                  }, function(resData, jwRes) {
                     console.log(JSON.stringify(resData));
                     if (jwRes.statusCode != 201) {
                        toastr.error('Error al guardar tiempo de la incidencia Remota', 'Gestión Incidencia');
                     }
                  });
               }

            }

            function buscarIncidencias() {

               io.socket.get('/incidencia/incidenciasTicket?ticket=' + ticket + '', function(resData, jwres) {

                  if (jwres.statusCode == 201 && resData.length >= 1) {

                     validarUsuarioPertenecientesTicket();
                     buscarUsuariosPertenecientesTicket();
                     buscarClientesPertenecientesTicket();

                     var fecha = new Date(resData[0].idTicket.fechaApertura);
                     var options = {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: 'numeric',
                        second: 'numeric'
                     };

                     $('#detalleTicket').html('<h5>#' + resData[0].idTicket.codigo + ' | ' + resData[0].idTicket.asunto + ' &nbsp;&nbsp;&nbsp;<small>Expandir para ver detalles</small></h5>');
                     $('#aperturaTicket').html('' + fecha.toLocaleDateString("es-ES", options) + ' <i class="fa fa-clock-o"></i>');
                     $('#estadoTicket').html('<i class="fa fa-s"><span class="label label-success">' + resData[0].idTicket.prioridad + '</span></i>');
                     $('#numeroTicket').html('# ' + resData.length);
                     $('#ultimoRegistro').empty();
                     $('#ultimoRegistro').html('<a class="anclaUnica" href="#ancla' + resData.length + '" data-ancla="ancla' + resData.length + '">Ir al último registro</a>');

                     var htmlOut = '';
                     var totalIncidencias = resData.length;
                     var desplegado = 'collapse';

                     var htmlIncidencia = '';
                     var htmlArchivos = '';
                     var tiempo = '';
                     var estado = '';
                     var modificacionIncidencia = 'block';

                     for (var i = 0; i < resData.length; i++) {

                        var fechaCovertirInicio = new Date(resData[i].tiempo[0].fechaInicio);
                        var fechaInicio = fechaCovertirInicio.toLocaleDateString("es-ES", options);


                        var fechaConvertirFinal = new Date(resData[i].tiempo[0].fechaFinal);
                        var fechaFinal = fechaConvertirFinal.toLocaleDateString("es-ES", options);

                        if (fechaFinal == '31 de diciembre de 1969 19:00:00') {
                           fechaFinal = 'S/F';
                           tiempo = 'S/T';
                           $("#panelAviso1").css("display", "block");
                           $("#panelAviso3").css("display", "none");
                           $("#panelAviso2").css("display", "none");
                           estado = 'block';
                        } else {

                           $("#panelAviso1").css("display", "none");
                           $("#panelAviso3").css("display", "block");
                           $("#panelAviso2").css("display", "none");
                           tiempo = resData[i].tiempo[0].tiempo;
                           estado = 'none';

                        }

                        if (resData[0].idTicket.estado != "VIGENTE") {
                           $("#panelAviso2").css("display", "block");
                           $("#panelAviso1").css("display", "none");
                           $("#panelAviso3").css("display", "none");
                           estado = 'none';
                           modificacionIncidencia = 'none';
                        }

                        if (totalIncidencias === (i + 1) && resData[0].idTicket.estado == "VIGENTE") {
                           desplegado = 'collapse in';
                        }

                        var archivos = resData[i].archivos.length;

                        htmlIncidencia +=
                           '<div class="row">' +
                           '<div class="col-lg-12">' +
                           '<div class="ibox collapsed">' +
                           '<div class="ibox-title" style="color: black; font-weight: bold">' +
                           '<h5>Incidencia N# ' + (i + 1) + '| <small>Resposable: ' + resData[i].cliente_usuario + '</small>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <small>Expandir para visualizar incidencia</small></h5>' +
                           '<div class="ibox-tools">' +
                           '<a data-toggle="collapse" data-target="#' + resData[i].idIncidencia + '">' +
                           '<i style="color: black">' + resData[i].lugarTrabajo + '&nbsp;&nbsp;&nbsp;</i>' +
                           '</a>' +
                           '<a data-toggle="collapse" data-target="#' + resData[i].idIncidencia + '"  name="ancla' + (i + 1) + '" id="ancla' + (i + 1) + '">' +
                           '<i class="fa fa-chevron-up"></i>' +
                           '</a>' +
                           '</div>' +
                           '</div>' +
                           '<div id="' + resData[i].idIncidencia + '" class="' + desplegado + ' well" style="background: white">'

                        +
                        '<div class="row">' +
                        '<div class="col-md-3">' +
                        '<div class="contact-box">' +
                        '<div class="col-sm-12">' +
                        '<h3>' +
                        '<strong>' + resData[i].cliente_usuario + '</strong>' +
                           '</h3>' +
                           '<p>' +
                           '<i class="fa fa-clock-o"></i> <b>COMIENZO: </b>' + fechaInicio + '</p>' +
                           '<p><i class="fa fa-clock-o"></i> <b>FIN: </b>' + fechaFinal + '</p>' +
                           '<p><i class="fa fa-clock-o"></i> <b>TIEMPO FINAL: </b>' + tiempo + '</p> ' +
                           '<address>' +
                           '<strong>Ticket #: ' + resData[i].idTicket.codigo + '</strong>' +
                           '<br>' +
                           '<br>' +
                           '<button type="button" class="btn btn-outline btn-primary btn-sm" data-toggle="modal" data-target="#mdArchivos" onclick="asignarIdIncidenciaArchivo(' + resData[i].idIncidencia + ')" style="width: 100%; display:' + estado + '"> <b>Agregar Archivos</b> </button>' +
                           '<br>' +
                           '<br>' +
                           '<br>' +
                           '<br>' +
                           '<input type="submit" value="Finalizar Seguimiento" class="btn btn-outline btn-danger btn-sm" onclick="finalizarIncidencia(\'' + resData[i].tiempo[0].idTiempoIncidencia + '\',\'' + resData[i].tiempo[0].fechaInicio + '\',\'' + resData[i].idIncidencia + '\')" style="width: 100%; display:' + estado + '">' +
                           '</address>' +
                           '</div>' +
                           '<div class="clearfix"></div>' +
                           '</div>' +
                           '</div>' +
                           '<div class="col-md-9">' +
                           '<div class="contact-box" style="background: #F7F7F7">' +
                           '<div class="col-sm-12">' +
                           '<u><p style="font-size: 15px; color: black"><b>SOPORTE </b>' + resData[i].lugarTrabajo + '</p></u>' +
                           '<div id="label' + resData[i].idIncidencia + '" class="label label-warning" style="display: none">Asegurese de guardar los cambios para que puedan ser visualizados.</div><div style="width: 100%" class="' + resData[i].idIncidencia + '">' + resData[i].descripcion + '</div> <br>' +
                           '<button id="edit" class="btn btn-default" style="float: right; display: ' + modificacionIncidencia + '" onclick="edit(' + resData[i].idIncidencia + ')"><i class="fa fa-edit"></i></button>' +
                           '<button id="save" class="btn btn-info" style="float: right; display: ' + modificacionIncidencia + '" onclick="save(' + resData[i].idIncidencia + ')"><i class="fa fa-save"></i></button> <br><br>' +
                           '<hr><h5 style="font-weight: bold">' + archivos + ' Archivos Adjunto/s</h5> <button class="btn btn-default" style="float: right; display: ' + modificacionIncidencia + '" data-toggle="modal" data-target="#mdArchivos" onclick="asignarIdIncidenciaArchivo(' + resData[i].idIncidencia + ')"><i class="fa fa-files-o"></i></button> <br> ' +
                           '' + obtenerArchivos(JSON.stringify(resData[i].archivos)) + '' +
                           '</div>' +
                           '<div class="clearfix"></div>' +
                           '</div>' +
                           '</div>' +
                           '</div>'

                        +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '</div>';

                     }

                     $('#incidenciasDetalles').empty();
                     $('#incidenciasDetalles').html(htmlIncidencia);

                  } else {
                     validarUsuarioPertenecientesTicket();
                  }
               });
            }

            var descripcionIncidencia = '';

            var edit = function(idIncidencia) {

               descripcionIncidencia = '';
               descripcionIncidencia = $('.' + idIncidencia + '').summernote('code');
               $('.' + idIncidencia + '').summernote({
                  focus: true,
                  toolbar: [
                     ['style'],
                     ['fontStyle', ['fontname', 'fontsize']],
                     ['color', ['color']],
                     ['para', ['ul', 'ol', 'paragraph']],
                     ['insert', ['picture', 'table']],
                  ],
                  fontNames: ['Arial Narrow'],
               });

               $("#label" + idIncidencia + "").css("display", "block");

            };

            var save = function(idIncidencia) {
               var descripcion = $('.' + idIncidencia + '').summernote('code');

               if (descripcionIncidencia == '') {
                  toastr.info('No se modificó la incidencia, editela primero.', 'Gestión Incidencia');
                  descripcionIncidencia = '';
               } else if (descripcionIncidencia == descripcion) {
                  toastr.info('Descripción de la Incidencia editada correctamente.', 'Gestión Incidencia');
                  descripcionIncidencia = '';
               } else {
                  io.socket.post('/incidencia/updateDescription', {
                     idIncidencia: idIncidencia,
                     descripcion: descripcion
                  }, function(resData, jwRes) {
                     console.log(resData);
                     if (jwRes.statusCode == 201) {
                        toastr.success('Descripción de la Incidencia editada correctamente', 'Gestión Incidencia');
                        descripcionIncidencia = '';
                     } else {
                        toastr.error('Error al editar la descripción de la Incidencia', 'Gestión Incidencia');
                        descripcionIncidencia = '';
                     }
                  });
               }
               $('.' + idIncidencia + '').summernote('destroy');
               $("#label" + idIncidencia + "").css("display", "none");
            };

            function finalizarIncidencia(idTiempoIncidencia_, fechaInicio_, idIncidencia_) {


               io.socket.post('/incidencia/verifyUserEndIncidencia', {
                  id_cliente_usuario: idUsuarioSesion,
                  idIncidencia: idIncidencia_
               }, function(resData, jwRes) {
                  if (jwRes.statusCode == 201) {

                     if (resData == 'false') {
                        toastr.error('Usted no abrió la incidencia por lo tanto no puede cerrar la misma', 'Gestión Incidencia');
                     } else {

                        var fechaConvertirInicio = new Date(fechaInicio_);
                        var fechaInicio = fechaConvertirInicio.getFullYear() + "-" + (fechaConvertirInicio.getMonth() + 1) + "-" + fechaConvertirInicio.getDate();
                        var tiempoInicio = fechaConvertirInicio.getHours() + ":" + fechaConvertirInicio.getMinutes() + ":" + fechaConvertirInicio.getSeconds();

                        var fechaConvertirFinal = new Date();
                        var fechaFinal = fechaConvertirFinal.getFullYear() + "-" + (fechaConvertirFinal.getMonth() + 1) + "-" + fechaConvertirFinal.getDate();
                        var tiempoFinal = fechaConvertirFinal.getHours() + ":" + fechaConvertirFinal.getMinutes() + ":" + fechaConvertirFinal.getSeconds();

                        var tiempoTotal = convertirASegundos(fechaInicio, tiempoInicio, fechaFinal, tiempoFinal);

                        io.socket.post('/tiempo_incidencia/insertFinalDateTime', {
                           fechaFinal: (fechaFinal + ' ' + tiempoFinal),
                           tiempo: tiempoTotal,
                           idTiempoIncidencia: idTiempoIncidencia_
                        }, function(resData, jwRes) {
                           if (jwRes.statusCode == 201) {
                              toastr.success('Seguimiento Finalizado Exitosamente', 'Gestión Incidencia');
                              buscarIncidencias();
                           } else {
                              toastr.error('Error al guardar tiempo final de la incidencia', 'Gestión Incidencia');
                           }
                        });

                     }
                  } else {
                     toastr.error('Error al buscar perteneciente de la incidencia', 'Gestión Incidencia');
                  }
               });

            }

            function asignarIdIncidenciaArchivo(idIncidencia_) {
               $('#idIncidencia').val(idIncidencia_);
               $('#idIncidenciaVisible').html(idIncidencia_);
            }

            function validarUsuarioPertenecientesTicket() {
               io.socket.post('/usuario/searchValidateUsuariosTicket', {
                  idTicket: ticket,
                  idUsuario: idUsuarioSesion
               }, function(resData, jwres) {

                  if (jwres.statusCode == 201) {
                     if (resData == 'false') {
                        $("#panelAviso1").css("display", "none");
                        //$("#panelAviso2").css("display", "none");
                        $("#panelAviso3").css("display", "none");
                        toastr.warning('No pertenece al ticket por lo tanto no podrá realizar el registro de incidencias', 'Gestión Incidencia');
                     } else {
                        toastr.success('Acceso Exitoso a las incidencias del Ticket', 'Gestión Incidencia');
                     }
                  }

               });
            }

            function buscarUsuariosPertenecientesTicket() {
               io.socket.post('/usuario/searchUsuariosAsignadosTicket', {
                  idTicket: ticket
               }, function(resData, jwres) {
                  if (jwres.statusCode == 201) {

                     var htmlOut = '';
                     for (var i = 0; i < resData.length; i++) {
                        htmlOut +=
                           '<li class="dd-item">' +
                           '<div class="dd-handle">' +
                           '<span class="label label-primary">' +
                           '<i class="fa fa-ticket"></i>' +
                           '</span> &nbsp;' + resData[i].nombre + '' +
                           ' </div>' +
                           '</li>';
                     }

                     $('#usuariosAsignadosTicket').empty();
                     $('#usuariosAsignadosTicket').append(htmlOut);

                  } else {
                     toastr.error('Error al buscar usuarios asignados al ticket', 'Gestión Staffs');
                  }
               });
            }

            function buscarClientesPertenecientesTicket() {
               io.socket.post('/cliente/searchClientesAsignadoTicket', {
                  idTicket: ticket
               }, function(resData, jwres) {
                  if (jwres.statusCode == 201) {

                     var htmlOut = '';
                     for (var i = 0; i < resData.length; i++) {
                        htmlOut +=
                           '<li class="dd-item">' +
                           '<div class="dd-handle">' +
                           '<span class="label label-info">' +
                           '<i class="fa fa-ticket"></i>' +
                           '</span> &nbsp;' + resData[i].nombre + '' +
                           ' </div>' +
                           '</li>';
                     }

                     $('#clientesAsignadosTicket').empty();
                     $('#clientesAsignadosTicket').append(htmlOut);

                  } else {
                     toastr.error('Error al buscar clientes asignados al ticket', 'Gestión Staffs');
                  }
               });
            }


            $("#btnCargarClientes").click(function() {
               buscarClientes();
            });

            $("#btnAsignarCliente").click(function() {
               var idCliente_ = $('#idClienteNuevo').val();
               if (idCliente_ != '') {
                  asignarClienteTicket(idCliente_);
               }

            });

            function asignarClienteTicket(idCliente_) {

               io.socket.post('/cliente_ticket/saveClienteTicket', {
                  idTicket: ticket,
                  idCliente: idCliente_
               }, function(resData, jwRes) {

                  if (jwRes.statusCode == 201) {
                     toastr.success('Cliente Asignado Exitosamente al Ticket', 'Gestión Incidencia');

                  } else if (jwRes.statusCode == 400) {
                     toastr.warning('El Cliente que desea Asignar ya pertenece al Ticket', 'Gestión Incidencia');
                  } else {
                     toastr.error('Error al Asignar Cliente al Ticket', 'Gestión Incidencia');
                  }
               });

            }

            function buscarClientes() {

               var empresa = '';
               io.socket.post('/ticket/searchEmpresaClienteStaffQuery', {
                  idTicket: ticket
               }, function(resData, jwRes) {

                  if (jwRes.statusCode == 201) {
                     empresa = resData[0].empresa;

                     io.socket.post('/cliente_ticket/searchClienteTicket', {
                        empresa: empresa
                     }, function(resData, jwRes) {

                        if (jwRes.statusCode == 201) {
                           var htmlOut = '';
                           for (var i = 0; i < resData.length; i++) {
                              htmlOut += '<option value="' + resData[i].idCliente + '">' + resData[i].nombre + '</option>'
                           }

                           $('#idClienteNuevo').empty();
                           $('#idClienteNuevo').append(htmlOut);

                           $('#idClienteNuevo').multiselect('destroy');
                           $('#idClienteNuevo').multiselect({
                              includeSelectAllOption: true,
                              enableFiltering: true,
                              buttonWidth: '100%',
                              maxHeight: 200
                           });

                        } else {
                           toastr.error('Error al Buscar Clientes', 'Gestión Incidencia');
                        }
                     });

                  } else {
                     toastr.error('Error al Buscar Empresa Perteneciente al Ticket', 'Gestión Incidencia');
                  }
               });
            }

            function EnvioEmailIncidencia(idIncidencia_) {

               var datosEmail = '';
               var destinatariosEmail = '';
               io.socket.post('/incidencia/searchIncidenciaEmail', {
                  idIncidencia: idIncidencia_
               }, function(resData, jwRes) {

                  if (jwRes.statusCode == 201) {
                     datosEmail = resData[0];

                     io.socket.post('/incidencia/serchEmailTicket', {
                        idTicket: ticket
                     }, function(resData, jwRes) {

                        if (jwRes.statusCode == 201) {
                           destinatariosEmail = resData[0];

                           $.post("/incidencia/sendEmailIncidencia", {
                              datosEmail: datosEmail,
                              destinatariosEmail: destinatariosEmail
                           }, function(resData, jwRes) {
                              toastr.success('Correo Electrónico Enviado Exitosamente', 'Gestión Correo Electrónico Incidencia');
                           }).fail(function(xhr, ajaxOptions, thrownError) {
                              toastr.error('Error al Enviar Correo Electrónico', 'Gestión Correo Electrónico Incidencia');
                           });

                        }
                     });

                  }
               });
            }

            function envioEmailFinTicket() {

               var datosEmail = '';
               var destinatariosEmail = '';
               io.socket.post('/incidencia/searchTicketEmail', {
                  idTicket: ticket
               }, function(resData, jwRes) {

                  if (jwRes.statusCode == 201) {
                     datosEmail = resData[0];

                     io.socket.post('/incidencia/serchEmailTicket', {
                        idTicket: ticket
                     }, function(resData, jwRes) {

                        if (jwRes.statusCode == 201) {
                           destinatariosEmail = resData[0];

                           $.post("/incidencia/sendEmailTicket", {
                              datosEmail: datosEmail,
                              destinatariosEmail: destinatariosEmail
                           }, function(resData, jwRes) {
                              toastr.success('Correo Electrónico Enviado Exitosamente', 'Gestión Correo Electrónico Finalización Ticket');
                           }).fail(function(xhr, ajaxOptions, thrownError) {
                              toastr.error('Error al Enviar Correo Electrónico', 'Gestión Correo Electrónico Finalización Ticket');
                           });

                        }
                     });

                  }
               });
            }

            function validarCampos(formulario) {


               var idTicketIncidencia = $('#idTicketIncidencia').val().length;
               var summernote = $('#summernote').val().length;

               if (formulario == 3) {
                  if (idTicketIncidencia > 0) {
                     if (summernote > 0) {
                        $("#btnGuardarIncidencia").attr("href", "#tab-2");
                        return true;
                     } else {
                        toastr.error('Ingresar la Descripción de la Incidencia', 'Gestión Incidencia');
                     }
                  } else {
                     toastr.error('Ingresar el Código del Ticket Asignado', 'Gestión Incidencia');
                  }
               }

               return false;
            }

            function convertirASegundos(fechaInicio, tiempoInicio, fechaFin, tiempoFin) {

               var inicio = new Date(fechaInicio + ' ' + tiempoInicio);
               var fin = new Date(fechaFin + ' ' + tiempoFin);

               var diferencia = ((inicio - fin) / 1000);
               var segundosTotales = String(diferencia);
               var total = segundosTotales.replace('-', '');

               return total;

            }
         </script>
         <% } else { %>
            <script>
               location.replace('/');
            </script>
            <% } %>