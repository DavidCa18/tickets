<% if (req.session.me) { %>

   <div id="wrapper">

      <nav class="navbar-default navbar-static-side" role="navigation">
         <div class="sidebar-collapse">
            <ul class="nav metismenu" id="side-menu">
               <li class="nav-header">
                  <div class="dropdown profile-element">
                     <span>
                <img alt="image" class="img-circle" src="logo.png" width="30%" height="10%" />
              </span>
                     <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                        <span class="clear">
                  <span class="block m-t-xs">
                    <strong class="font-bold">Usuario</strong>
                  </span>
                        <%= req.session.me.nombre %>
                           <input type="text" value="<%= req.session.me.nombre %>" id="creador" style="display: none">
                           <b class="caret"></b>
                           </span>
                           </span>
                     </a>
                     <ul class="dropdown-menu animated fadeInRight m-t-xs">
                        <li>
                           <a href="/GloblalPerfil?user=<%= req.session.me.idUsuario %>">Perfil</a>
                        </li>
                        <li>
                           <a href="usuario/logout">Cerrar Sesión </a>
                        </li>
                     </ul>
                  </div>
                  <div class="logo-element">
                     TI+
                  </div>
               </li>
               <li>
                  <a href="/AdministradorInicio" class="active">
                     <i class="fa fa-area-chart"></i>
                     <span class="nav-label">Inicio</span>
                  </a>
               </li>
               <li>
                  <a href="">
                     <i class="fa fa-id-badge"></i>
                     <span class="nav-label">Clientes</span>
                     <span class="fa arrow"></span>
                  </a>
                  <ul class="nav nav-second-level collapse">
                     <li>
                        <a href="/AdministradorClienteEmpresa">
                           <i class="fa fa-bank"></i>Empresas</a>
                     </li>
                     <li>
                        <a href="/AdministradorClienteTrabajador">
                           <i class="fa fa-id-card-o"></i>Contactos</a>
                     </li>
                  </ul>
               </li>
               <li>
                  <a href="/AdministradorProducto">
                     <i class="fa fa-shopping-cart"></i>
                     <span class="nav-label">Productos</span>
                  </a>
               </li>
               <li class="active">
                  <a href="">
                     <i class="fa fa-ticket"></i>
                     <span class="nav-label">Tickets</span>
                     <span class="fa arrow"></span>
                  </a>
                  <ul class="nav nav-second-level collapse">
                     <li>
                        <a href="/AdministradorTicketRegistrar">
                           <i class="fa fa-save"></i>Nuevo Ticket</a>
                     </li>
                     <li>
                        <a href="/AdministradorTicketIncidencias">
                           <i class="fa fa-th-list"></i>Incidencias</a>
                     </li>
                     <li class="active">
                        <a href="/AdministradorTicketBusquedas">
                           <i class="fa fa-search"></i>Consultas</a>
                     </li>
                  </ul>
               </li>
               <li>
                  <a href="/AdministradorReporteTicket">
                     <i class="fa fa-file"></i>
                     <span class="nav-label">Informe Ticket</span>
                  </a>
               </li>
            </ul>

         </div>
      </nav>

      <div id="page-wrapper" class="gray-bg">
         <div class="row border-bottom">
            <nav class="navbar navbar-static-top  " role="navigation" style="margin-bottom: 0">
               <div class="navbar-header">
                  <a class="navbar-minimalize minimalize-styl-2 btn btn-primary " href="#">
                     <i class="fa fa-bars"></i>
                  </a>
               </div>
               <ul class="nav navbar-top-links navbar-right">
                  <li>
                     <span class="m-r-sm text-muted welcome-message">Bienvenido
                <%= req.session.me.nombre %>
              </span>
                  </li>

                  <li>
                     <a href="usuario/logout">
                        <i class="fa fa-sign-out"></i> Cerrar Sesión
                     </a>
                  </li>
               </ul>

            </nav>
         </div>
         <div class="row wrapper border-bottom white-bg page-heading">
            <div class="col-sm-4">
               <h2>Ticket</h2>
               <ol class="breadcrumb">
                  <li>
                     <a href="">Búsquedas</a>
                  </li>
                  <li class="active">
                     <strong>Búsquedas Tickets</strong>
                  </li>
               </ol>
            </div>
         </div>

         <div class="wrapper wrapper-content animated fadeInRight">
            <div class="row">
               <div class="col-md-12">
                  <div class="ibox float-e-margins">
                     <div class="ibox-title">
                        <h5>Gestión Consulta Tickets |
                           <small>El siguiente módulo le permitira realizar consultas de los tickets existentes por varios parametros.</small>
                        </h5>
                        <div class="ibox-tools">
                           <a class="collapse-link">
                              <i class="fa fa-chevron-up"></i>
                           </a>
                           <a class="close-link">
                              <i class="fa fa-times"></i>
                           </a>
                        </div>
                     </div>
                     <div class="ibox-content">
                        <div class="row">
                           <div class="col-lg-3 col-md-3 col-sm-12">
                              <div class="form-group">
                                 <label>Código</label>
                                 <input type="text" placeholder="Buscar Código" class="form-control" id="codigo">
                              </div>
                           </div>
                           <div class="col-lg-3 col-md-3 col-sm-12">
                              <div class="form-group">
                                 <label>Asunto</label>
                                 <input type="text" placeholder="Buscar Asunto" class="form-control" id="asunto">
                              </div>
                           </div>
                           <div class="col-lg-3 col-md-3 col-sm-12">
                              <div class="form-group">
                                 <label>Prioridad</label>
                                 <select id="prioridad" class="form-control" multiple>
                        <option value="ALTA">ALTA</option>
                        <option value="MEDIA">MEDIA</option>
                        <option value="BAJA">BAJA</option>
                      </select>
                              </div>
                           </div>

                           <div class="col-lg-3 col-md-3 col-sm-12">

                              <div class="form-group">
                                 <label>Staffs</label>
                                 <select id="usuarioTicket" class="form-control" multiple>
                      </select>
                              </div>

                           </div>

                        </div>
                        <div class="row">

                           <div class="col-lg-3 col-md-3 col-sm-12">
                              <div class="form-group">
                                 <label>Estado Ticket</label>
                                 <select id="estado" class="form-control" multiple>
                        <option value="VIGENTE">VIGENTE</option>
                        <option value="FINALIZADO POR FACTURAR">FINALIZADO POR FACTURAR</option>
                        <option value="FINALIZADO">FINALIZADO</option>
                      </select>
                              </div>
                           </div>

                           <div class="col-lg-3 col-md-3 col-sm-12">
                              <div class="form-group">
                                 <label>Empresa / Cliente</label>
                                 <input type="text" placeholder="Buscar Empresa / Cliente" class="form-control" id="empresa">
                              </div>
                           </div>
                           <div class="col-lg-3 col-md-3 col-sm-12">
                              <div class="form-group" id="data_5">
                                 <label>Rango Fecha Apertura</label>
                                 <div class="input-daterange input-group" id="datepicker">
                                    <input type="text" class="input-sm form-control" name="start" id="fechaInicio" placeholder="Fecha Inicio" style="height: 35px">
                                    <span class="input-group-addon">Hasta</span>
                                    <input type="text" class="input-sm form-control" name="end" id="fechaFin" placeholder="Fecha Final" style="height: 35px">
                                 </div>
                              </div>
                           </div>
                           <div class="col-lg-3 col-md-3 col-sm-12">
                              <div class="form-group">
                                 <label>&nbsp;</label>
                                 <br>
                                 <button type="submit" class="btn btn-success" id="btnBuscar" style="width: 100%">
                        <i class="fa fa-search"></i> Buscar</button>
                              </div>
                           </div>
                        </div>

                        <div class="row">
                           <div class="col-lg-12" id="panIncidencia" style="display: none">
                              <div class="ibox">
                                 <div class="ibox-title">
                                    <h5>Resultados de la Búsqueda</h5>
                                    <div class="ibox-tools">
                                       <a class="collapse-link">
                                          <i class="fa fa-chevron-up"></i>
                                       </a>
                                       <a class="close-link">
                                          <i class="fa fa-times"></i>
                                       </a>
                                    </div>
                                 </div>

                                 <div class="ibox-content" style="background: white;">

                                    <div class="row">
                                       <div class="col-lg-12">
                                          <div class="m-b-md">
                                             <h2 style="text-align: center; font-weight: bold">Resumen del Ticket</h2>
                                          </div>
                                          <dl class="dl-horizontal">
                                             <input type="text" style="display: none" id="idTicket" value="0" />
                                             <dt>Estado:</dt>
                                             <dd id="estadoR"></dd>
                                             <dt>Prioridad:</dt>
                                             <dd id="prioridadR"></dd>
                                          </dl>
                                       </div>
                                    </div>

                                    <div class="row">
                                       <div class="col-lg-5 col-xs-5">
                                          <dl class="dl-horizontal">
                                             <dt>Creado Por:</dt>
                                             <dd id="creadorR"></dd>
                                             <dt>N° Ticket:</dt>
                                             <dd id="codigoR"> </dd>
                                             <dt>Staff/s Involucrados</dt>
                                             <dd id="staffR"></dd>
                                          </dl>
                                       </div>
                                       <div class="col-lg-7 col-xs-7">
                                          <dl class="dl-horizontal">
                                             <dt>Fecha Apertura:</dt>
                                             <dd id="fechaAperturaR"> </dd>
                                             <dt>Fecha Cierre:</dt>
                                             <dd id="fechaCierreR"> </dd>
                                             <dt>Tiempo Total:</dt>
                                             <dd id="horasTotalesR"></dd>
                                          </dl>
                                       </div>
                                    </div>

                                    <div class="row">
                                       <div class="col-lg-12">
                                          <dl class="dl-horizontal">
                                             <dt>Empresa:</dt>
                                             <dd id="empresaR"></dd>
                                             <dt>Cliente/s</dt>
                                             <dd id="clientesR"> </dd>
                                          </dl>
                                       </div>
                                    </div>

                                    <div class="row">
                                       <div class="col-lg-12" id="cluster_info">
                                          <dl class="dl-horizontal">
                                             <dt>Marca:</dt>
                                             <dd id="marcaR"></dd>
                                             <dt>Modelo:</dt>
                                             <dd id="modeloR"></dd>
                                             <dt>Versión:</dt>
                                             <dd id="versionR"></dd>
                                          </dl>
                                       </div>
                                    </div>
                                    <div class="row">
                                       <div class="col-lg-12" id="cluster_info">
                                          <dl class="dl-horizontal">
                                             <dt>Asunto:</dt>
                                             <dd id="asuntoR"></dd>
                                             <dt>Revisión Física:</dt>
                                             <dd id="revisionFisicaR">

                                             </dd>
                                             <dd>&nbsp;</dd>
                                             <dd id="panelRevisionFisicaR" style="display: none">
                                                <div class="row">
                                                   <div class="col-md-11">
                                                      <input type="text" class="form-control" id="revisionFisicaRegistrar" placeholder="Ingresar Descripción de Revisión Física">
                                                   </div>
                                                   <div class="col-md-1">
                                                      <button class="btn btn-defult" id="btnGuardarFisica">
                                      <i class="fa fa-save"></i>
                                    </button>
                                                   </div>
                                                </div>
                                             </dd>
                                             <dt>Revisión Lógica:</dt>
                                             <dd id="revisionLogicaR">
                                             </dd>
                                             <dd>&nbsp;</dd>
                                             <dd id="panelRevisionLogicaR" style="display: none">
                                                <div class="row">
                                                   <div class="col-md-11">
                                                      <input type="text" class="form-control" id="revisionLogicaRegistrar">
                                                   </div>
                                                   <div class="col-md-1">
                                                      <button class="btn btn-defult" id="btnGuardarLogica">
                                      <i class="fa fa-save"></i>
                                    </button>
                                                   </div>
                                                </div>
                                             </dd>
                                          </dl>
                                       </div>
                                    </div>
                                    <h2 style="text-align: center; font-weight: bold">Incidencias Ticket</h2>
                                    <hr>

                                    <div class="row" id="incidenciasR">
                                    </div>

                                 </div>
                              </div>
                           </div>

                        </div>

                        <div class="row" style="background: white">
                           <br>
                           <div class="col-md-12" id="panBusqueda" style="display: none">

                              <div class="table-responsive">
                                 <table id="tableTickets" class="table table-bordered" border="1" width="100%" cellspacing="4" cellpadding="4">
                                    <thead>
                                       <tr>
                                          <th style="background: #1D84C6; color: white">Id</th>
                                          <th style="background: #1D84C6; color: white">Código</th>
                                          <th style="background: #1D84C6; color: white">Asunto</th>
                                          <th style="background: #1D84C6; color: white">Prioridad</th>
                                          <th style="background: #1D84C6; color: white">Estado</th>
                                          <th style="background: #1D84C6; color: white">Fecha Apertura</th>
                                          <th style="background: #1D84C6; color: white">Fecha Cierre</th>
                                          <th style="background: #1D84C6; color: white">Tiempo Total</th>
                                          <th style="background: #1D84C6; color: white">Cliente/s</th>
                                          <th style="background: #1D84C6; color: white">Producto</th>
                                          <th style="background: #1D84C6; color: white">Incidencias</th>
                                       </tr>
                                    </thead>
                                    <tbody id="tbBodyTicket">
                                       <tr>
                                          <td></td>
                                          <td></td>
                                          <td></td>
                                          <td></td>
                                          <td></td>
                                          <td></td>
                                          <td></td>
                                          <td></td>
                                          <td></td>
                                          <td></td>
                                          <td></td>
                                       </tr>
                                    </tbody>
                                 </table>
                              </div>
                           </div>
                        </div>

                     </div>
                  </div>
               </div>
            </div>
         </div>

         <div class="footer">
            <div>
               <strong>Innovacloud </strong> Ticketing &copy; 2020 - 2021
            </div>
         </div>

      </div>

      <script>
         $('#prioridad').multiselect('destroy');
         $('#prioridad').multiselect({
            includeSelectAllOption: true,
            enableFiltering: true,
            buttonWidth: '100%',
            maxHeight: 280
         });

         $('#estado').multiselect('destroy');
         $('#estado').multiselect({
            includeSelectAllOption: true,
            enableFiltering: true,
            buttonWidth: '100%',
            maxHeight: 280
         });

         $('#data_5 .input-daterange').datepicker({
            format: 'yyyy-mm-dd',
            keyboardNavigation: false,
            forceParse: false,
            autoclose: true
         });

         buscarStaffs();

         function buscarStaffs() {

            io.socket.get('/usuario?rol=USUARIO', function(resData, jwres) {

               if (jwres.statusCode == 200) {
                  var htmlOut = '';
                  for (var i = 0; i < resData.length; i++) {
                     htmlOut += '<option value="' + resData[i].idUsuario + '">' + resData[i].nombre + '</option>';
                  }

                  $('#usuarioTicket').empty();
                  $('#usuarioTicket').append(htmlOut);

                  $('#usuarioTicket').multiselect('destroy');
                  $('#usuarioTicket').multiselect({
                     includeSelectAllOption: true,
                     enableFiltering: true,
                     buttonWidth: '100%',
                     maxHeight: 280
                  });
               }
            });
         }

         function obtenerArchivos(json) {

            var retorno = '' + json;

            var archivo = JSON.parse(json);
            var htmlOut = '';
            for (var i = 0; i < archivo.length; i++) {
               htmlOut += '<a href="' + archivo[i].ubicacion + '" target="_blank" class="btn btn-default" style="font-size: 14px" ><i class="fa fa-file-archive-o"></i> ' + archivo[i].nombre + '</a>&nbsp;&nbsp;&nbsp;';

            }

            retorno = htmlOut;

            return retorno;
         }


         function buscarTicketDetalle(ticket) {

            $("#panIncidencia").css("display", "block");
            $("#panBusqueda").css("display", "none");
            $("#panelRevisionFisicaR").css({
               "display": "none"
            });
            $("#panelRevisionLogicaR").css({
               "display": "none"
            });

            var options = {
               year: 'numeric',
               month: 'long',
               day: 'numeric',
               hour: 'numeric',
               minute: 'numeric',
               second: 'numeric'
            };

            io.socket.post('/ticket/searchTicketQuery', {
               idTicket: ticket
            }, function(resData, jwres) {

               if (jwres.statusCode == 201) {

                  var fechaApertura = new Date(resData.fechaApertura);
                  var fechaCierre = new Date(resData.fechaCierre);

                  $('#idTicket').val(resData.idTicket);
                  $('#codigoR').empty();
                  $('#codigoR').append(resData.codigo);
                  $('#creadorR').empty();
                  $('#creadorR').append(resData.creador);
                  $('#asuntoR').empty();
                  $('#asuntoR').append(resData.asunto);

                  $('#revisionFisicaR').empty();
                  $('#revisionFisicaR').append(resData.revision_fisica + '<button class="btn btn-default" style="float: right" onclick="mostrarFisica()"><i class="fa fa-edit"></i></button>');

                  $('#revisionLogicaR').empty();
                  $('#revisionLogicaR').append(resData.revision_logica + '<button class="btn btn-default" style="float: right" onclick="mostrarLogica()"><i class="fa fa-edit"></i></button>');

                  if (fechaApertura.toLocaleDateString("es-ES", options) != '31 de diciembre de 1969 19:00:00') {
                     $('#fechaAperturaR').empty();
                     $('#fechaAperturaR').append(fechaApertura.toLocaleDateString("es-ES", options));
                  }

                  $('#fechaCierreR').empty();
                  if (fechaCierre.toLocaleDateString("es-ES", options) != '31 de diciembre de 1969 19:00:00') {
                     $('#fechaCierreR').empty();
                     $('#fechaCierreR').append(fechaCierre.toLocaleDateString("es-ES", options));
                  }

                  $('#horasTotalesR').empty();
                  $('#horasTotalesR').append(resData.tiempo_total);
                  $('#estadoR').empty();
                  $('#estadoR').append(resData.estado);
                  $('#prioridadR').empty();
                  $('#prioridadR').append(resData.prioridad);

                  io.socket.post('/ticket/searchIncidenciaQuery', {
                     idTicket: ticket
                  }, function(resData, jwRes) {
                     var htmlIncidencia = ''
                     if (jwres.statusCode == 201) {

                        for (var i = 0; i < resData.length; i++) {

                           var fechaCovertirInicio = new Date(resData[i].tiempo[0].fechaInicio);
                           var fechaInicio = '';

                           var fechaConvertirFinal = new Date(resData[i].tiempo[0].fechaFinal);
                           var fechaFinal = '';

                           if (fechaCovertirInicio.toLocaleDateString("es-ES", options) != '31 de diciembre de 1969 19:00:00') {
                              fechaInicio = fechaCovertirInicio.toLocaleDateString("es-ES", options);
                           }

                           if (fechaConvertirFinal.toLocaleDateString("es-ES", options) != '31 de diciembre de 1969 19:00:00') {
                              fechaFinal = fechaConvertirFinal.toLocaleDateString("es-ES", options);
                           }

                           htmlIncidencia += '<div class="col-md-12">' +
                              '<table border="0">' +
                              '<tr>' +
                              '<td>' +
                              '<dt>Responsable Incidencia:&nbsp;</dt>' +
                              '</td>' +
                              '<td >&nbsp;&nbsp;&nbsp;' + resData[i].cliente_usuario + '</td>' +
                              '</tr>' +
                              '<tr>' +
                              '<td>' +
                              '<dt>Inicio Incidencia:&nbsp;</dt>' +
                              '</td>' +
                              '<td>&nbsp;&nbsp;&nbsp;' + fechaInicio + '</td>' +
                              '</tr>' +
                              '<tr>' +
                              '<td>' +
                              '<dt>Fin Incidencia:&nbsp;</dt>' +
                              '</td>' +
                              '<td>&nbsp;&nbsp;&nbsp;' + fechaFinal + '</td>' +
                              '</tr>' +
                              '<tr>' +
                              '<td>' +
                              '<dt>Tiempo Total Incidencia:&nbsp;</dt>' +
                              '</td>' +
                              '<td >&nbsp;&nbsp;&nbsp;' + resData[i].tiempo[0].tiempo + '</td>' +
                              '</tr>' +
                              '<tr>' +
                              '<td colspan="2">&nbsp;</td>' +
                              '</tr>' +
                              '</table>' +
                              '<div class="well" style="font-size: 14px">' +
                              '<p id="lugarTrabajoR">' +
                              '<u>' +
                              '<b>SOPORTE </b> ' + resData[i].lugarTrabajo + '</u>' +
                              '<p>' +
                              '<div style="width: 100%">' + resData[i].descripcion + '</div>' +
                              '<br> Archivo/s' +
                              '<br>' +
                              '<br>' +
                              '<div>' + obtenerArchivos(JSON.stringify(resData[i].archivos)) + '</div>' +
                              '</div><hr>' +
                              '</div>';
                        }

                        $('#incidenciasR').empty();
                        $('#incidenciasR').append(htmlIncidencia);
                        io.socket.post('/ticket/searchProductoQuery', {
                           idTicket: ticket
                        }, function(resData, jwRes) {
                           var htmlProducto = ''
                           if (jwres.statusCode == 201) {

                              $('#marcaR').empty();
                              $('#marcaR').append(resData[0].marca);
                              $('#modeloR').empty();
                              $('#modeloR').append(resData[0].modelo);
                              $('#versionR').empty();
                              $('#versionR').append(resData[0].version);

                              io.socket.post('/ticket/searchEmpresaClienteStaffQuery', {
                                 idTicket: ticket
                              }, function(resData, jwRes) {
                                 var htmlEmpresaClienteStaff = ''
                                 if (jwres.statusCode == 201) {

                                    $('#empresaR').empty();
                                    $('#empresaR').append(resData[0].empresa);
                                    $('#clientesR').empty();
                                    $('#clientesR').append(resData[0].clientes);
                                    $('#staffR').empty();
                                    $('#staffR').append(resData[0].staff);

                                 }
                              });

                           }
                        });

                     }
                  });

               }

            });

         }


         $("#btnBuscar").click(function() {
            buscarTicketsParametros();
            $("#panIncidencia").css("display", "none");
            $("#panBusqueda").css("display", "block");
         });

         function buscarTicketsParametros() {

            var consulta = '';

            var codigo = $('#codigo').val();
            var asunto = $('#asunto').val();
            var prioridad = $('#prioridad').val();
            var estado = $('#estado').val();
            var empresa = $('#empresa').val();
            var fechaInicio = $('#fechaInicio').val();
            var fechaFin = $('#fechaFin').val();
            var staffs = $('#usuarioTicket').val();


            var asignado = $('#creador').val();

            if (codigo.length != 0) {
               consulta += ('ticket.codigo LIKE "%' + codigo + '%" AND ');
            }
            if (asunto.length != 0) {
               consulta += ('ticket.asunto LIKE "%' + asunto + '%" AND ');
            }
            if (prioridad.length != 0) {
               var prioridadConcat = '';
               for (var i = 0; i < prioridad.length; i++) {
                  prioridadConcat += 'ticket.prioridad LIKE "%' + prioridad[i] + '%" OR ';
               }
               consulta += '(' + (prioridadConcat.substr(0, (prioridadConcat.length - 3))) + ') AND ';
            }
            if (estado.length != 0) {
               var estadoConcat = '';
               for (var i = 0; i < estado.length; i++) {
                  estadoConcat += 'ticket.estado LIKE "%' + estado[i] + '%" OR ';
               }
               consulta += '(' + (estadoConcat.substr(0, (estadoConcat.length - 3))) + ') AND ';
            }
            if (empresa.length != 0) {
               consulta += (
                  "( " +
                  "(SELECT GROUP_CONCAT( ( SELECT cliente.nombre FROM cliente WHERE cliente.idCliente = cliente_ticket.idCliente ) SEPARATOR ',' )  FROM cliente_ticket WHERE cliente_ticket.idTicket = ticket.idTicket ) LIKE '%" + empresa + "%' " +
                  "OR " +
                  "(SELECT GROUP_CONCAT( ( SELECT empresa.nombre FROM empresa INNER JOIN cliente ON empresa.idEmpresa = cliente.idEmpresa WHERE cliente.idCliente = cliente_ticket.idCliente ) SEPARATOR ',' ) FROM cliente_ticket WHERE cliente_ticket.idTicket = ticket.idTicket) LIKE '%" + empresa + "%' " +
                  ") AND ");
            }

            if (staffs.length != 0) {
               var staffsConcat = '';
               for (var i = 0; i < staffs.length; i++) {
                  staffsConcat += "((SELECT GROUP_CONCAT( ( SELECT usuario.idUsuario FROM usuario WHERE usuario.idUsuario = usuario_ticket.idUsuario ) SEPARATOR ',' )  FROM usuario_ticket WHERE usuario_ticket.idTicket = ticket.idTicket ) LIKE '%" + staffs + "%') OR ";
               }
               consulta += '(' + (staffsConcat.substr(0, (staffsConcat.length - 3))) + ') AND ';
            }

            if (fechaInicio.length != 0 && fechaFin.length != 0) {
               consulta += ('DATE(ticket.fechaApertura) >= "' + fechaInicio + '" && DATE(ticket.fechaApertura) <= "' + fechaFin + '" AND ');
            }


            io.socket.post('/ticket/ticketsParams', {
               consulta: consulta.substr(0, (consulta.length - 4)),
               asignado: asignado
            }, function(resData, jwres) {

               if (jwres.statusCode == 201) {

                  var options = {
                     year: 'numeric',
                     month: 'long',
                     day: 'numeric',
                     hour: 'numeric',
                     minute: 'numeric',
                     second: 'numeric'
                  };

                  var table = $('#tableTickets').DataTable();
                  table.destroy();
                  $('#tableTickets').empty();
                  table = $('#tableTickets').DataTable({
                     "ordering": false,
                     pageLength: 8,
                     responsive: true,
                     dom: '<"html5buttons"B>lTfgitp',
                     buttons: [{
                        extend: 'copy'
                     }, {
                        extend: 'excel',
                        title: 'Ticket-Venta'
                     }, {
                        extend: 'pdf',
                        title: 'Ticket-Venta'
                     }, ],
                     data: resData,
                     columns: [{
                        data: 'idTicket',
                        title: "Id"
                     }, {
                        data: 'codigo',
                        title: "Código"
                     }, {
                        data: 'asunto',
                        title: "Asunto"
                     }, {
                        data: 'estado',
                        title: "Estado"
                     }, {
                        data: 'prioridad',
                        title: "Prioridad"
                     }, {
                        data: 'fechaApertura',
                        title: "Fecha Apertura",
                        render: function(row, data, index) {
                           var fechaApertura = new Date(row);
                           return fechaApertura.toLocaleDateString("es-ES", options);
                        }
                     }, {
                        data: 'fechaCierre',
                        title: "Fecha Cierre",
                        render: function(row, data, index) {

                           var fechaConvertirCierre = new Date(row);
                           var fechaFinal = '';

                           if (fechaConvertirCierre.toLocaleDateString("es-ES", options) != '31 de diciembre de 1969 19:00:00') {
                              fechaFinal = fechaConvertirCierre.toLocaleDateString("es-ES", options);
                           }

                           return fechaFinal;
                        }
                     }, {
                        data: 'tiempo_total',
                        title: "Duracion"
                     }, {
                        data: 'nombreCliente',
                        title: "Cliente/s"
                     }, {
                        data: 'nombreProducto',
                        title: "Producto"
                     }, ],
                     "columnDefs": [{
                        "targets": [10],
                        "data": null,
                        "width": "1%",
                        "defaultContent": "<button id='btnSeguimiento' class='btn btn-default'><i class='fa fa-th-list'></i> Incidencias</button>"
                     }, {
                        "targets": [0],
                        "visible": false,
                        "searchable": false
                     }]
                  });

                  $('#tableTickets tbody').on('click', '#btnSeguimiento', function() {
                     var data = table.row($(this).parents('tr')).data();
                     buscarTicketDetalle(data.idTicket);

                  });

               }
            });
         }

         $("#btnGuardarFisica").click(function() {

            var revisionFisica = $('#revisionFisicaRegistrar').val();
            var idTicket = $('#idTicket').val();

            io.socket.post('/ticket/createTicketRevision', {
               seleccion: 1,
               revisionFisica: revisionFisica,
               idTicket: idTicket
            }, function(resData, jwRes) {

               if (jwRes.statusCode == 201) {
                  toastr.success('Revisión Física Registrada Exitosamente', 'Gestión Ticket');

                  $('#revisionFisicaR').empty();
                  $('#revisionFisicaR').append(revisionFisica + '<button class="btn btn-default" style="float: right" onclick="mostrarFisica()"><i class="fa fa-edit"></i></button>');

                  $("#panelRevisionFisicaR").css({
                     "display": "none"
                  });
                  $('#revisionFisicaRegistrar').val('');
               } else {
                  toastr.error('Error al Registrara la Revisión Física', 'Gestión Ticket');
               }
            });

         });

         $("#btnGuardarLogica").click(function() {
            var revisionLogica = $('#revisionLogicaRegistrar').val();
            var idTicket = $('#idTicket').val();

            io.socket.post('/ticket/createTicketRevision', {
               seleccion: 2,
               revisionLogica: revisionLogica,
               idTicket: idTicket
            }, function(resData, jwRes) {

               if (jwRes.statusCode == 201) {
                  toastr.success('Revisión Lógica Registrada Exitosamente', 'Gestión Ticket');

                  $('#revisionLogicaR').empty();
                  $('#revisionLogicaR').append(revisionLogica + '<button class="btn btn-default" style="float: right" onclick="mostrarLogica()"><i class="fa fa-edit"></i></button>');

                  $("#panelRevisionLogicaR").css({
                     "display": "none"
                  });
                  $('#revisionLogicaRegistrar').val('');
               } else {
                  toastr.error('Error al Registrar la Revisión Lógica', 'Gestión Ticket');
               }
            });
         });

         function mostrarFisica() {
            $("#panelRevisionFisicaR").css({
               "display": "block"
            });
         }

         function mostrarLogica() {
            $("#panelRevisionLogicaR").css({
               "display": "block"
            });
         }
      </script>
      <% } else { %>
         <script>
            location.replace('/');
         </script>
         <% } %>